\chapter{Proofs}

\section{Proofs for section 3.3.2}

\begin{lemma}
\label{lem:app1}
Let $a$ be a term and $a^0$ be a proper subterm of $a$. When
\[
a \longrightarrow' b \land a^0 \longrightarrow^{aux} b^0
\]
and both reduction steps are derived by the ``Subst'' rule, then there is a $d$ such that
\[
a[a^0 \mapsto b^0] \longrightarrow' d \land b {\longrightarrow^{aux}}^* d.
\]

\begin{proof}
Since $a^0 = q_{r'}[\sigma']$ for some equation $r'$, we know that $a^0$ is a function or destructor call, and not a constructor call. Because $a = q_r[\sigma], b = t_r[\sigma]$ for an equation $r$, $r$ and $r'$ don't overlap, and $a^0$ is a proper subterm of $a$, it follows that $a^0$ is a subterm of a right-hand side of $\sigma$. Put in another way, there is a variable $x$ and a term $t(a^0)$ with subterm $a^0$ such that $\{x \mapsto t\} \subseteq \sigma$. Define a $\sigma_{mod}$ with $dom(\sigma_{mod}) = \sigma$ as $\sigma_{mod}(x) = t(b^0)$ and $\sigma_{mod}(y) = \sigma(y)$ for $y \neq x$, and choose $d = t_r[\sigma_{mod}]$. The two desired reductions can be derived as follows.
\begin{enumerate}
\item By the ``Subst'' rule for $r$:
\[
a[a^0 \mapsto b^0] = q_r[\sigma_{mod}] \longrightarrow' t_r[\sigma_{mod}] = d
\]
This is possible because all subterms of $a$ are values under judgement $\vdash'_v$, and its subterm $a^0$ is replaced by $b^0$ for which $\langle a^0 \rangle^{aux^{-1}} = \langle b^0 \rangle^{aux^{-1}}$ holds, thus it is $\vdash'_v b^0$, as well.

\item Let $p^x_1, ..., p^x_n$ denote the positions of $b^0$ in $b$.
\[
b = t_r[\sigma] \longrightarrow^{aux} t_r[\sigma][t(b^0)]_{p^x_1} \longrightarrow^{aux} ... \longrightarrow^{aux} t_r[\sigma][t(b^0)]_{p^x_1}...[t(b^0)]_{p^x_n} = t_r[\sigma_{mod}] = d
\]
\end{enumerate}
\end{proof}
\end{lemma}

\begin{lemma}
\label{lem:app2}
Let $a$ be a term and $a^0$ be a proper subterm of $a$. When
\[
a \longrightarrow^{aux} b \land a^0 \longrightarrow' b^0
\]
and $a[a^0 \mapsto []] \in EC[\vdash'_v]$ and both reduction steps are derived by the ``Subst'' rule, then there is a $d$ such that
\[
a[a^0 \mapsto b^0] \longrightarrow^{aux} d \land b \longrightarrow' d.
\]

\begin{proof}
Since $a^0 = q_{r'}[\sigma']$ for some equation $r'$, we know that $a^0$ is a function or destructor call, and not a constructor call. Because $a = q_r[\sigma], b = t_r[\sigma]$ for an equation $r$, $r$ and $r'$ don't overlap, and $a^0$ is a proper subterm of $a$, it follows that $a^0$ is a subterm of a right-hand side of $\sigma$. Put in another way, there is a variable $x$ and a term $t(a^0)$ with subterm $a^0$ such that $\{x \mapsto t\} \subseteq \sigma$. Define a $\sigma_{mod}$ with $dom(\sigma_{mod}) = \sigma$ as $\sigma_{mod}(x) = t(b^0)$ and $\sigma_{mod}(y) = \sigma(y)$ for $y \neq x$, and choose $d = t_r[\sigma_{mod}]$. The two desired reductions can be derived as follows.
\begin{enumerate}
\item Because $a \longrightarrow^{aux} b$, it must be $r = \epsilon$, as there is no other equation with unequal sides and its left-hand side interpreted the same as the right-hand side. Thus we have:
\[
a[a^0 \mapsto b^0] = q_\epsilon[\sigma_{mod}] \longrightarrow^{aux} t_\epsilon[\sigma_{mod}] = d
\]

\item By its definition, $t_\epsilon$ is syntactically a copattern, and it is linear like all copatterns considered in this work. It follows that $x$ only appears once in $t_\epsilon$, at some position $p^x$. Define $\mathcal{E}' = b[a^0 \mapsto []]_{p^x}$ and we have the desired reduction
\[
b = t_\epsilon[\sigma] = \mathcal{E}'[a^0] \longrightarrow' \mathcal{E}'[b^0] = t_\epsilon[\sigma_{mod}] = d,
\]
since $\mathcal{E}' \in EC_<[\vdash'_v]$, as shown in the following. It is $a[a^0 \mapsto []] \in EC_<[\vdash'_v]$ and
\[
a[a^0 \mapsto []] = q_\epsilon[\sigma_{[]}], \mathcal{E}' = b[a^0 \mapsto []]_{p^x} = t_\epsilon[\sigma_{[]}] = aux(\langle q_\epsilon \rangle^{vars})[\sigma_{[]}]
\]
with $\sigma_{[]} = (\sigma \setminus \{x \mapsto t(a^0)\}) \cup \{x \mapsto t([])\}$. Because $a[a^0 \mapsto []] \in EC_<[\vdash'_v]$, we know that all terms that $\sigma_{[]}$ assigns to variables to the left (with respect to $<$) of the hole in $q_\epsilon[\sigma_{[]}]$ are values under judgement $\vdash'_v$. Since $\langle q_\epsilon \rangle^{vars}$ doesn't change the order of the variables, it follows that all terms that $\sigma_{[]}$ assigns to variables to the left (w.r.t. $<$) of the hole in $aux(\langle q_\epsilon \rangle^{vars})[\sigma_{[]}]$ are such values, as well.

\end{enumerate}
\end{proof}
\end{lemma}

\cdpaux*
\begin{proof}
We make use of the fact that a reduction that can be derived by multiple applications of the ``Cong" rule can also be derived by just one application of the ``Cong" rule. When a reduction is derived by the ``Subst'' rule, it can also be derived by applying the ``Cong'' rule for the empty evaluation context on top of that. Thus, we have the following:
\begin{itemize}
\item From $a \longrightarrow' b$: $a = \mathcal{E}[a^0], b = \mathcal{E}[b^0]$ for an $\mathcal{E} \in \textrm{EC}_<[\vdash'_v]$ and terms $a^0, b^0$ with $a^0 \longrightarrow' b^0$ and $a^0 = q_r[\sigma], b^0 = t_r[\sigma]$ for some equation $r$.

\item From $a \longrightarrow^{aux} c$: $a = \mathcal{E}^{aux}[a'^0], c = \mathcal{E}^{aux}[c^0]$ for some term with hole $\mathcal{E}^{aux}$ and terms $a'^0, c^0$ with $a'^0 \longrightarrow^{aux} c^0$ and $a'^0 = q_\epsilon[\sigma'], c^0 = t_\epsilon[\sigma']$.
\end{itemize}

We compare $a^0$ and $a'^0$ and distinguish four cases.
\begin{itemize}
\item $a^0 = a'^0$. Then simply choose $d = b$. Since $\langle prg \rangle$ has no overlapping lhss, it must be $b^0 = c^0$. Thus it is $b = c$ and the property holds.

\item $a'^0$ is a proper subterm of $a^0$. By \autoref{lem:app1}, we have a $d^0$ with $a^0[a'^0 \mapsto c^0] \longrightarrow' d^0$ and $b^0 \longrightarrow^{aux} d^0$. Choose $d = \mathcal{E}[d^0]$. The property holds since (a) $b = \mathcal{E}[b^0] \longrightarrow^{aux} \mathcal{E}[d^0] = d$ and (b) $c = \mathcal{E}^{aux}[c^0] = \mathcal{E}[a^0[a'^0 \mapsto c^0]] \longrightarrow' \mathcal{E}[d^0] = d$.

\item $a^0$ is a proper subterm of $a'^0$. Because $a = \mathcal{E}[a^0]$, $a^0$ is a subterm of $a'^0$, and $\mathcal{E} \in \textrm{EC}[\vdash'_v]$, it is $a'^0[a^0 \mapsto []] \in \textrm{EC}[\vdash'_v]$. By \autoref{lem:app2}, we have a $d^0$ with $a'^0[a^0 \mapsto b^0] \longrightarrow^{aux} d^0$ and $c^0 \longrightarrow' d^0$. Choose $d = \mathcal{E}^{aux}[d^0]$. The property holds since (a) $b = \mathcal{E}^{aux}[a'^0[a^0 \mapsto b^0]] \longrightarrow^{aux} \mathcal{E}^{aux}[d^0]$ and (b) $c = \mathcal{E}^{aux}[c^0] = \mathcal{E}[a'^0[a^0 \mapsto []] \mapsto []][c^0] \longrightarrow' \mathcal{E}[a'^0[a^0 \mapsto []] \mapsto []][d^0] = \mathcal{E}^{aux}[d^0] = d$.

\item Neither $a'^0$ is a subterm of $a^0$, nor the other way around. Then choose $d$ as $a$ with $a'^0$ replaced by $c^0$ and $a^0$ replaced by $b^0$. The property holds because $b = \mathcal{E}[b^0] = \mathcal{E}^{aux}[a^0 \mapsto b^0][a'^0] \longrightarrow^{aux} \mathcal{E}^{aux}[a^0 \mapsto b^0][c^0] = d$ and $c = \mathcal{E}^{aux}[c^0] = \mathcal{E}[a'^0 \mapsto c^0][a^0] \longrightarrow' \mathcal{E}[a'^0 \mapsto c^0][b^0] = d$. This second reduction is possible because, by \autoref{lem:gec1}, $\mathcal{E}[a'^0 \mapsto c^0] \in \textrm{EC}[\vdash'_v]$ since $\mathcal{E} \in \textrm{EC}[\vdash'_v]$ and $\langle a'^0 \rangle^{aux^{-1}} = \langle c^0 \rangle^{aux^{-1}}$ and thus $\vdash'_v a'^0$ iff $\vdash'_v c^0$.
\end{itemize}

\end{proof}

\begin{lemma}
\label{lem:app3}

For a term $t$ with $\vdash'_v t$ and $\not\vdash_v t$, there is a term $t'$ and reductions
\[
t \longrightarrow t'
\]
and
\[
t \longrightarrow^{aux} t'.
\]

\begin{proof}

By induction on the structure of $t$. We distinguish two cases.
\begin{enumerate}
\item All immediate subterms of $t$ are values under judgement $\vdash_v$. We will show that $t$ matches $q_\epsilon$, and from this the desired reductions immediately follow. Because $\not\vdash_v t$, by the definition of the value judgement $t$ itself has to match some lhs $q$ of $\langle prg \rangle$. Since $\vdash'_v t$, there cannot be an equation $q'$ of $prg$ with $\langle q \rangle^{aux^{-1}} = q'$. By the definition of extractions, the only equation of $\langle prg \rangle$ for which this can be the case is $q = q_\epsilon$. Consequently, we have some $\sigma$ that substitutes only with terms which are values under judgement $\vdash_v$ and the desired reductions
\[
t = q_\epsilon[\sigma] \longrightarrow t_\epsilon[\sigma], t = q_\epsilon[\sigma] \longrightarrow^{aux} t_\epsilon[\sigma].
\]

\item There are immediate subterms of $t$ which aren't values under judgement $\vdash_v$. Obtain a generic evaluation context $\mathcal{GE} \in \textrm{EC}_<$ by replacing all immediate subterms $t_i$ of $t$ with placeholders $p_i$, with $p_1, ..., p_n$ ordered according to the order $<$ of $\textrm{EC}_<$. Let $k$ be the smallest index for which $\not\vdash_v t_k$. We define $\mathcal{E} \in \textrm{EC}_<[\vdash_v]$ as the instance of $\mathcal{GE}$ which assigns, for all $i \neq k$, $t_i$ to placeholder $p_i$, and the hole $[]$ to placeholder $p_k$. By the induction hypothesis, we have a term $t'_k$ and reductions
\[
t_k \longrightarrow t'_k, t_k \longrightarrow^{aux} t'_k.
\]
Consequently, we have the desired term as $t' = \mathcal{E}[t'_k]$ and reductions
\[
t = \mathcal{E}[t_k] \longrightarrow \mathcal{E}[t'_k] = t', t = \mathcal{E}[t_k] \longrightarrow^{aux} \mathcal{E}[t'_k] = t'.
\]
\end{enumerate}

\end{proof}

\end{lemma}

\compl*
\begin{proof}

There is an evaluation context $\mathcal{E} \in \textrm{EC}_<[\vdash'_v]$, with $\mathcal{E} \not\in \textrm{EC}_<[\vdash_v]$, and terms $a^0, b^0$, such that $a = \mathcal{E}[a^0], b = \mathcal{E}[b^0]$. Because $\mathcal{E} \not\in \textrm{EC}_<[\vdash_v]$, there has to be a subterm $t$ of $\mathcal{E}$ with $\not\vdash_v t$. Consider the generic evaluation context $\mathcal{GE} \in \textrm{EC}_<$ that $\mathcal{E}$ is an instance of, and the order $<$ on its placeholders. Construct an evaluation context $\mathcal{E}' \in \textrm{EC}_<[\vdash_v]$ from $\mathcal{E}$ by replacing the smallest placeholder of $\mathcal{GE}$, that $\mathcal{E}$ replaced with a term $t$ with $\not\vdash_v t$, by the hole $[]$. By \autoref{lem:app3}, we have a term $t_{aux}$ and reductions
\[
t \longrightarrow t_{aux}, t \longrightarrow^{aux} t_{aux},
\]
and consequently there is a $c = \mathcal{E}'[t_{aux}]$ with
\[
\mathcal{E}'[t] \longrightarrow \mathcal{E}'[t_{aux}], \mathcal{E}'[t] \longrightarrow^{aux} \mathcal{E}'[t_{aux}].
\]

\end{proof}

\correctb*
\begin{proof}
By induction on the length $n$ of the sequence.

For $n = 0$, the translation doesn't change anything, thus correctness trivially holds.

Now, suppose $n = n' + 1$ such that correctness of the translation holds for all sequences of length $n'$ (the induction hypothesis). This means that
\[
s^{uc}_1 \longrightarrow_{prg} ... \longrightarrow_{prg} s^{uc}_{m'} = \langle s_{n-1} \rangle^{aux^{-1}}
\]
for the sequence $(s^{uc}_1, ..., s^{uc}_m) := uc(s_1, ..., s_{n-1})$. Two cases will be distinguished, according to the definition of $uc$:
\begin{itemize}
\item \underline{Case 1:} $s_{n-1} \neq s_n \land s_{n-1} \sim s_n$.
Then it is $uc((s_1, ..., s_n)) = uc((s_1, ..., s_{n-1})) = (s^{uc}_1, ..., s^{uc}_m)$. By the above, all steps in the sequence are indeed reduction steps of the relevant reduction. Because $s_{n-1} \sim s_n$, it is $\langle s_n \rangle^{aux^{-1}} = \langle s_{n-1} \rangle^{aux^{-1}} = \langle s^{uc}_n \rangle^{aux^{-1}}$.

\item \underline{Case 2:} otherwise.
Then it is $uc((s_1, ..., s_n)) = uc((s_1, ..., s_{n-1})) \cdot (\langle s_n \rangle^{aux^{-1}})$. By the above, all steps before the last are indeed reduction steps of the relevant reduction. The final term is by definition $\langle s_n \rangle^{aux^{-1}}$.

It remains to be shown why the final step is a reduction step of the relevant reduction. By the induction hypothesis, this step is $(\langle s_{n-1} \rangle^{aux^{-1}}, \langle s_n \rangle^{aux^{-1}})$. By assumption, it is $s_{n-1} \longrightarrow_{\langle prg \rangle} s_n$, and $\langle s_{n-1} \rangle^{aux^{-1}} \longrightarrow_{prg} \langle s_n \rangle^{aux^{-1}}$ follows from the more general $a \longrightarrow_{\langle prg \rangle} b \Rightarrow \langle a \rangle^{aux^{-1}} \longrightarrow_{\langle prg \rangle} \langle b \rangle^{aux^{-1}}$. This can be shown by induction on the derivation of the left-hand side reduction, by using
\[
\langle prg \rangle \vdash_v t \Rightarrow prg \vdash_v \langle t \rangle^{aux^{-1}},
\]
for all terms $t$, and the compatibility of evaluation contexts and $aux^{-1}$, i.e., $\langle \mathcal{E}[t] \rangle^{aux^{-1}} = \langle \mathcal{E} \rangle^{aux^{-1}}[\langle t \rangle^{aux^{-1}}]$.

\end{itemize}
\end{proof}

\clearpage
\newpage
